تمام، تم التعديل.

لقد حدّثت **القسم 2** ليشير بوضوح إلى `DummyJSON` وأضفت الرابط الأساسي له.

---

### **تقرير توثيق البنية التحتية لـ Supabase - مشروع Exclusive Ecommerce (نسخة معدلة)**

**مقدمة:** هذا التقرير يوضح بالتفصيل هيكل قاعدة البيانات، العلاقات بين الجداول، وسياسات الأمان التي تم إعدادها في Supabase. الهدف هو تزويد مطور الواجهة الأمامية بالمعرفة اللازمة لإنشاء دوال API فعالة وآمنة للتفاعل مع **بيانات المستخدمين** (المفضلة، الطلبات)، ودمجها مع **بيانات المنتجات** التي يتم جلبها من مصدر خارجي.

---

### 1. مصادقة المستخدمين (User Authentication)

**النظام:** يتم الاعتماد بشكل كامل على نظام Supabase Authentication المدمج.

**جدول المستخدمين:** يقوم Supabase بإدارة جدول `users` داخل `auth schema` تلقائيًا. يحتوي هذا الجدول على معلومات المستخدمين الأساسية مثل `id` (من نوع `uuid`)، `email`، إلخ.

**ملاحظة للمطور:** لا تحتاج إلى التعامل المباشر مع هذا الجدول. ستستخدم دوال Supabase JS Client مثل `supabase.auth.signUp()` و `supabase.auth.signInWithPassword()` للتسجيل والدخول، ودالة `supabase.auth.getUser()` للحصول على بيانات المستخدم الحالي.

---

### 2. كتالوج المنتجات (External API - DummyJSON)

**النظام:** تم اتخاذ قرار استراتيجي **بعدم** تخزين بيانات المنتجات والتصنيفات (Products & Categories) داخل Supabase لتقليل التكلفة وزيادة المرونة.

**المصدر:** سيتم جلب جميع بيانات المنتجات والتصنيفات مباشرة من واجهة برمجة التطبيقات الخارجية **`DummyJSON`**.
* **الرابط الأساسي: `https://dummyjson.com`**

**ملاحظة للمطور:** مهمتك هي استدعاء (fetch) هذا الـ API الخارجي (مثل `dummyjson.com/products`) مباشرة من الواجهة الأمامية (Client-Side) لعرض المنتجات في المتجر. **لا يوجد جدول `products` أو `categories` في Supabase.**

---

### 3. خاصية قائمة المفضلة (Wishlist Feature)

تم بناء هذه الخاصية باستخدام جدول واحد مؤمن بسياسات RLS صارمة.

**جدول `wishlist`:**

* **الغرض:** يعمل كجدول ربط لتسجيل المنتجات التي يضيفها كل مستخدم إلى مفضلته.
* **الأعمدة:**
    * `id (int8)`: مفتاح أساسي.
    * `user_id (uuid)`: مفتاح أجنبي يرتبط بـ `auth.users.id`.
    * `product_id (text)`: **(تعديل هام)** المعرّف الخاص بالمنتج الذي يتم جلبه من `DummyJSON`. هذا العمود **ليس** مفتاحًا أجنبيًا (No Foreign Key) ولا يرتبط بأي جدول داخل Supabase. تم اختياره كـ `text` ليقبل الـ ID القادم من الـ API (سواء كان رقماً أو نصاً).
    * `created_at (timestamptz)`: تاريخ الإضافة.

**سياسات الأمان (RLS):**

* **القاعدة:** المستخدم المسجل يمكنه فقط عرض، إضافة، وحذف العناصر من قائمته الخاصة فقط.
* **التطبيق:** تم تطبيق سياسات `SELECT`, `INSERT`, `DELETE` بشرط `auth.uid() = user_id`.

---

### 4. خاصية الطلبات والدفع (Orders & Checkout Feature)

تم بناء هذه الخاصية باستخدام تصميم احترافي مكون من جدولين لضمان تخزين كافة تفاصيل الطلبات بشكل صحيح.

**جدول `orders`:**

* **الغرض:** تخزين المعلومات العامة للطلب.
* **الأعمدة:**
    * `id (int8)`: رقم الطلب الفريد (مفتاح أساسي).
    * `user_id (uuid)`: مفتاح أجنبي يرتبط بـ `auth.users.id`.
    * `total_price (numeric)`: السعر الإجمالي للطلب.
    * `shipping_address (jsonb)`: لتخزين عنوان الشحن ككائن JSON.
    * `status (text)`: حالة الطلب (القيمة الافتراضية: 'pending').
    * `created_at (timestamptz)`: تاريخ إنشاء الطلب.

**جدول `order_items`:**

* **الغرض:** تخزين تفاصيل المنتجات داخل كل طلب على حدة.
* **الأعمدة:**
    * `id (int8)`: مفتاح أساسي.
    * `order_id (int8)`: مفتاح أجنبي يرتبط بـ `orders.id`.
    * `product_id (text)`: **(تعديل هام)** المعرّف الخاص بالمنتج الذي يتم جلبه من `DummyJSON`. هذا العمود **ليس** مفتاحًا أجنبيًا.
    * `quantity (int4)`: كمية المنتج المطلوب.
    * `price_at_purchase (numeric)`: **(هام جداً)** سعر المنتج في لحظة الشراء لضمان دقة السجلات، حيث قد يتغير سعره في `DummyJSON` لاحقاً.

**سياسات الأمان (RLS):**

* **جدول `orders`:** المستخدم يمكنه فقط عرض (`SELECT`) وإنشاء (`INSERT`) الطلبات الخاصة به.
* **جدول `order_items`:** المستخدم يمكنه فقط عرض (`SELECT`) وإضافة (`INSERT`) العناصر التي تنتمي إلى طلب يملكه هو.

---

### خلاصة لمطور الواجهة الأمامية:

لقد تم تجهيز قاعدة بيانات Supabase لتكون بمثابة "الباك-إند" لبيانات **المستخدمين** (Users, Wishlists, Orders). مهمتك ستنقسم إلى جزأين:

1.  **Supabase API (بيانات المستخدم):** كتابة الدوال (select, insert, delete) للجداول المؤمنة (`wishlist`, `orders`, `order_items`) للتعامل مع بيانات المستخدم المسجل.
2.  **`DummyJSON` (بيانات المنتجات):** استدعاء (Fetch) الـ API الخارجي (`dummyjson.com`) لعرض كتالوج المنتجات والتصنيفات.

**مثال لسير العمل (Workflow):**
عندما يضغط المستخدم "إضافة للمفضلة" على منتج:
1.  أنت تحصل على `id` المنتج من `DummyJSON`.
2.  تقوم باستدعاء دالة `Supabase` لعمل `insert` في جدول `wishlist`، وتمرر لها `user_id` (من `supabase.auth.getUser()`) و `product_id` (الذي حصلت عليه من `DummyJSON`).